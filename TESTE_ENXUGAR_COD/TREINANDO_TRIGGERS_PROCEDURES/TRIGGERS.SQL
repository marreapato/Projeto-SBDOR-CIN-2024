CREATE OR REPLACE TRIGGER SABER_VOO
BEFORE UPDATE ON PASSAGEM_TB
FOR EACH ROW
DECLARE
BEGIN

	DBMS_OUTPUT.PUT_LINE('PASSAGEM = '||:OLD.PK_LOCALIZADOR_PASSAGEM||' ALTERADA');

END CONTAR_PASSAGEIROS_VOO;

UPDATE PASSAGEM_TB SET VALOR_PASSAGEM = 412.89 WHERE PK_LOCALIZADOR_PASSAGEM = 1;

CREATE OR REPLACE TRIGGER DADO_INSERIDO_PASSAGEIRO
AFTER INSERT ON PASSAGEIRO_TB
FOR EACH ROW
BEGIN
    IF :NEW.SEXO = 'M' THEN 
    	DBMS_OUTPUT.PUT_LINE('SR. '||:NEW.NOME||' INSERIDO '||' CPF: '||:NEW.PK_CPF);
    ELSIF :NEW.SEXO = 'F' THEN
        DBMS_OUTPUT.PUT_LINE('SR. '||:NEW.NOME||' INSERIDO '||' CPF: '||:NEW.PK_CPF);
    END IF;
END DADO_INSERIDO_PASSAGEIRO;
/

SET SERVEROUTPUT ON;

CREATE OR REPLACE TRIGGER WHATS_UPDATED_PASSAGEIRO
BEFORE DELETE ON PASSAGEIRO_TB
FOR EACH ROW
BEGIN
	DBMS_OUTPUT.PUT_LINE('PASSAGEIRO DE CPF ' || :OLD.PK_CPF || ' DELETADO');
END WHATS_UPDATED_PASSAGEIRO;
/

DELETE FROM PASSAGEIRO_TB WHERE PK_CPF = '98765432198';

CREATE OR REPLACE TRIGGER UPDATED_PASSAGEIRO
BEFORE UPDATE ON PASSAGEIRO_TB
FOR EACH ROW
DECLARE
    V_IDADE NUMBER;
    ACOMPANHAMENTO_V VARCHAR2(3);
BEGIN
    V_IDADE := CALCULAR_IDADE_TRIGGER(:OLD.DATA_NASCIMENTO);
	IF V_IDADE <18 THEN
        ACOMPANHAMENTO_V := 'SIM';
	    DBMS_OUTPUT.PUT_LINE('ATUALIZACAO EM MENOR IDADE QUE ACOMPANHAMENTO ESPECIAL = '||ACOMPANHAMENTO_V);
	ELSE
        DBMS_OUTPUT.PUT_LINE('ATUALIZACAO EM MAIOR DE IDADE');
	END IF;
	DBMS_OUTPUT.PUT_LINE('VALOR ANTIGO:');
	DBMS_OUTPUT.PUT_LINE(:OLD.NOME||' '||:OLD.PK_CPF||' '||:OLD.DATA_NASCIMENTO||' '||:OLD.PK_CPF);
	DBMS_OUTPUT.PUT_LINE(:NEW.NOME||' '||:NEW.PK_CPF||' '||:NEW.DATA_NASCIMENTO||' '||:NEW.PK_CPF);
END UPDATED_PASSAGEIRO;

UPDATE PASSAGEIRO_TB P SET P.NOME = 'Savio Marcos' WHERE P.PK_CPF = '99988877766';

---

CREATE OR REPLACE TRIGGER CONTADOR_COMPRAS
BEFORE DELETE ON COMPRA_TB
FOR EACH ROW
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;
	V_CONTAGEM_COMPRA NUMBER;
BEGIN
    SELECT COUNT(*) INTO V_CONTAGEM_COMPRA FROM COMPRA_TB;
    DBMS_OUTPUT.PUT_LINE('CONTAGEM DE COMPRAS: '||V_CONTAGEM_COMPRA);

COMMIT;
END CONTADOR_COMPRAS;

DELETE COMPRA_TB C WHERE C.ID_COMPRA = 2;


------


CREATE OR REPLACE TRIGGER CONTADOR_COMPRAS_ATUALIZADAS
BEFORE UPDATE ON COMPRA_TB
FOR EACH ROW
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;
	V_CONTAGEM_COMPRA NUMBER;
BEGIN
    SELECT COUNT(R.PASSAGEM.PK_LOCALIZADOR_PASSAGEM) INTO V_CONTAGEM_COMPRA FROM COMPRA_TB C, TABLE(C.PASSAGENS_COMPRADAS) R WHERE C.ID_COMPRA = :OLD.ID_COMPRA;
    DBMS_OUTPUT.PUT_LINE('CONTAGEM DE PASSAGEIROS QUE SOFRERAM COM ALTERAÇÃO NA COMPRA: '||V_CONTAGEM_COMPRA);

COMMIT;
END CONTADOR_COMPRAS_ATUALIZADAS;

UPDATE COMPRA_TB C SET C.DATA_COMPRA = TO_DATE('22/09/2023','DD/MM/YYYY') WHERE C.ID_COMPRA = 4;

----

CREATE OR REPLACE TRIGGER CONTADOR_CPFS
AFTER UPDATE ON COMPRA_TB
FOR EACH ROW
DECLARE
    PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
    
    FOR CZINHO IN (
        SELECT DEREF(R.PASSAGEM.PASSAGEIRO).PK_CPF AS CPF 
        FROM COMPRA_TB C, TABLE(C.PASSAGENS_COMPRADAS) R 
        WHERE C.ID_COMPRA = :NEW.ID_COMPRA
    ) LOOP
        DBMS_OUTPUT.PUT_LINE('CPFS DE PASSAGEIROS NA COMPRA: ' || CZINHO.CPF);
    END LOOP;

COMMIT;
END CONTADOR_CPFS;

UPDATE COMPRA_TB C SET C.DATA_COMPRA = SYSDATE WHERE C.ID_COMPRA = 4;

SELECT DEREF(R.PASSAGEM.PASSAGEIRO).PK_CPF AS CPF FROM COMPRA_TB C, TABLE(C.PASSAGENS_COMPRADAS) R;



-- quantidade de passageiros de SDU PRA GRU QUANDO FOR UPDATE nesse voo

CREATE OR REPLACE TRIGGER CONTAR_SDU_GRU
BEFORE UPDATE ON VOO_TABLE
FOR EACH ROW 
DECLARE
V_CONTAGEM_PASSAGEIRO NUMBER;
V_ORIGEM VARCHAR2(3);
V_DESTINO VARCHAR2(3);
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
    V_ORIGEM := :OLD.ORIGEM;
	V_DESTINO := :OLD.DESTINO;
	IF V_ORIGEM = 'SDU' AND V_DESTINO = 'GRU' THEN
    	SELECT COUNT(DEREF(DEREF(PASSAGEM).PASSAGEIRO).PK_CPF) INTO V_CONTAGEM_PASSAGEIRO FROM VOO_TABLE V, TABLE(V.REFERE_SE) R WHERE V.ORIGEM = 'SDU' AND V.DESTINO='GRU';
    	DBMS_OUTPUT.PUT_LINE('CONTAGEM DE PASSAGEIROS AFETADOS PELA ATUALIZACAO = '||V_CONTAGEM_PASSAGEIRO);
	END IF;

END CONTAR_SDU_GRU;

SELECT V.ORIGEM,V.DESTINO,DEREF(R.PASSAGEM).PK_LOCALIZADOR_PASSAGEM, DEREF(DEREF(PASSAGEM).PASSAGEIRO).PK_CPF FROM VOO_TABLE V, TABLE(V.REFERE_SE) R WHERE V.ORIGEM = 'SDU' AND V.DESTINO='GRU';

UPDATE VOO_TABLE V SET V.HORA_EMBARQUE = '02:23' WHERE V.ORIGEM = 'SDU' AND V.DESTINO = 'GRU';
